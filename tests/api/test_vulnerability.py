"""
Vulnerability Management API Tests

Comprehensive tests for vulnerability scanning endpoints including:
- OpenVAS scanning
- Container scanning (Trivy)
- Network scanning (nmap)
- SBOM generation and analysis
- Risk scoring and threat intel enrichment
"""

import pytest
from fastapi.testclient import TestClient
from fastapi import HTTPException, status
from unittest.mock import patch, MagicMock

from defensive_toolkit.api.main import app

client = TestClient(app)


# =============================================================================
# Fixtures
# =============================================================================


@pytest.fixture
def mock_openvas_scanner():
    """Mock OpenVAS scanner."""
    scanner = MagicMock()
    scanner.connect.return_value = True
    scanner.get_scan_configs.return_value = [
        {"id": "config-1", "name": "Full and fast"},
        {"id": "config-2", "name": "Discovery"},
    ]
    scanner.create_target.return_value = "target-123"
    scanner.create_task.return_value = "task-123"
    scanner.start_task.return_value = True
    scanner.get_task_status.return_value = {
        "status": "Running",
        "progress": 50,
        "name": "API-Scan",
    }
    scanner.get_results.return_value = [
        {"cve_id": "CVE-2021-44228", "name": "Log4Shell", "severity": 10.0},
        {"cve_id": "CVE-2021-45046", "name": "Log4j DOS", "severity": 9.0},
    ]
    return scanner


@pytest.fixture
def mock_container_scanner():
    """Mock container scanner (Trivy)."""
    scanner = MagicMock()
    scanner.check_trivy.return_value = True
    scanner.scan_image.return_value = {
        "Results": [
            {
                "Target": "nginx:latest",
                "Vulnerabilities": [
                    {
                        "VulnerabilityID": "CVE-2023-1234",
                        "PkgName": "openssl",
                        "Severity": "HIGH",
                    }
                ],
            }
        ]
    }
    return scanner


@pytest.fixture
def mock_nmap_scanner():
    """Mock nmap scanner."""
    scanner = MagicMock()
    scanner.check_nmap.return_value = True
    scanner.scan_vulnerabilities.return_value = {
        "hosts": [
            {
                "ip": "192.168.1.1",
                "vulnerabilities": [{"cve": "CVE-2020-1234", "severity": "high"}],
            }
        ]
    }
    return scanner


@pytest.fixture
def mock_sbom_generator():
    """Mock SBOM generator."""
    generator = MagicMock()
    generator.check_syft.return_value = True
    generator.generate_sbom.return_value = {
        "bomFormat": "CycloneDX",
        "specVersion": "1.4",
        "components": [],
    }
    generator.analyze_sbom.return_value = {
        "component_count": 50,
        "license_summary": {"MIT": 30, "Apache-2.0": 20},
    }
    generator.validate_cisa_compliance.return_value = {
        "compliant": True,
        "checks": {"supplier_name": "pass", "component_version": "pass"},
    }
    return generator


@pytest.fixture
def mock_risk_scorer():
    """Mock risk scorer."""
    scorer = MagicMock()
    scorer.load_kev_catalog.return_value = True
    scorer.score_vulnerabilities.return_value = [
        {"cve_id": "CVE-2021-44228", "priority": "CRITICAL", "score": 98},
        {"cve_id": "CVE-2020-1234", "priority": "HIGH", "score": 75},
    ]
    scorer.check_kev.return_value = True
    return scorer


@pytest.fixture
def mock_threat_enricher():
    """Mock threat intel enricher."""
    enricher = MagicMock()
    enricher.load_kev.return_value = True
    enricher.enrich_vulnerabilities.return_value = [
        {
            "cve_id": "CVE-2021-44228",
            "in_kev": True,
            "epss_score": 0.975,
            "nvd_data": {"description": "Log4Shell"},
        }
    ]
    return enricher


# =============================================================================
# OpenVAS Scanning Tests
# =============================================================================


class TestOpenVASScanning:
    """Tests for OpenVAS scanning endpoints."""

    def test_start_openvas_scan(self, auth_headers, mock_openvas_scanner):
        """Test starting an OpenVAS scan."""
        with patch(
            "defensive_toolkit.api.routers.vulnerability.get_openvas_scanner"
        ) as mock_get:
            mock_get.return_value = mock_openvas_scanner

            request_data = {"target": "192.168.1.100", "scan_type": "discovery"}
            response = client.post(
                "/api/v1/vulnerability/scan/openvas",
                json=request_data,
                headers=auth_headers,
            )

            assert response.status_code == 200
            data = response.json()
            assert "task_id" in data
            assert data["target"] == "192.168.1.100"
            assert data["status"] == "started"

    def test_start_openvas_scan_requires_write_scope(self):
        """Test that OpenVAS scan requires write scope."""
        # Get read-only token
        auth_response = client.post(
            "/api/v1/auth/token",
            data={"username": "analyst", "password": "analyst123"},
        )
        readonly_token = auth_response.json()["access_token"]
        readonly_headers = {"Authorization": f"Bearer {readonly_token}"}

        request_data = {"target": "192.168.1.100", "scan_type": "discovery"}
        response = client.post(
            "/api/v1/vulnerability/scan/openvas",
            json=request_data,
            headers=readonly_headers,
        )

        assert response.status_code == 403

    def test_openvas_connection_failure(self, auth_headers, mock_openvas_scanner):
        """Test handling OpenVAS connection failure."""
        with patch(
            "defensive_toolkit.api.routers.vulnerability.get_openvas_scanner"
        ) as mock_get:
            mock_openvas_scanner.connect.return_value = False
            mock_get.return_value = mock_openvas_scanner

            request_data = {"target": "192.168.1.100", "scan_type": "discovery"}
            response = client.post(
                "/api/v1/vulnerability/scan/openvas",
                json=request_data,
                headers=auth_headers,
            )

            assert response.status_code == 503

    def test_get_scan_status(self, auth_headers, mock_openvas_scanner):
        """Test getting scan status."""
        with patch(
            "defensive_toolkit.api.routers.vulnerability.get_openvas_scanner"
        ) as mock_get:
            mock_get.return_value = mock_openvas_scanner

            response = client.get(
                "/api/v1/vulnerability/scan/task-123/status",
                headers=auth_headers,
            )

            assert response.status_code == 200
            data = response.json()
            assert data["task_id"] == "task-123"
            assert data["status"] == "Running"
            assert data["progress"] == 50

    def test_get_scan_results(self, auth_headers, mock_openvas_scanner):
        """Test getting scan results."""
        with patch(
            "defensive_toolkit.api.routers.vulnerability.get_openvas_scanner"
        ) as mock_get:
            mock_get.return_value = mock_openvas_scanner

            response = client.get(
                "/api/v1/vulnerability/scan/task-123/results",
                headers=auth_headers,
            )

            assert response.status_code == 200
            data = response.json()
            assert data["task_id"] == "task-123"
            assert data["vulnerability_count"] == 2
            assert "summary" in data
            assert data["summary"]["critical"] == 2


# =============================================================================
# Container Scanning Tests
# =============================================================================


class TestContainerScanning:
    """Tests for container scanning endpoints."""

    def test_scan_container_image(self, auth_headers, mock_container_scanner):
        """Test scanning a container image."""
        with patch(
            "defensive_toolkit.api.routers.vulnerability.get_container_scanner"
        ) as mock_get:
            mock_get.return_value = mock_container_scanner

            request_data = {
                "image": "nginx:latest",
                "severity": "MEDIUM",
                "scan_type": "vuln",
            }
            response = client.post(
                "/api/v1/vulnerability/scan/container",
                json=request_data,
                headers=auth_headers,
            )

            assert response.status_code == 200
            data = response.json()
            assert "scan_id" in data
            assert data["image"] == "nginx:latest"
            assert "results" in data

    def test_scan_container_invalid_severity(self, auth_headers):
        """Test container scan with invalid severity."""
        request_data = {
            "image": "nginx:latest",
            "severity": "INVALID",
            "scan_type": "vuln",
        }
        response = client.post(
            "/api/v1/vulnerability/scan/container",
            json=request_data,
            headers=auth_headers,
        )

        assert response.status_code == 422

    def test_container_scanner_unavailable(self, auth_headers):
        """Test handling when Trivy is unavailable."""
        with patch(
            "defensive_toolkit.api.routers.vulnerability.get_container_scanner"
        ) as mock_get:
            mock_get.side_effect = HTTPException(
                status_code=status.HTTP_503_SERVICE_UNAVAILABLE,
                detail="Trivy is not installed",
            )

            request_data = {"image": "nginx:latest"}
            response = client.post(
                "/api/v1/vulnerability/scan/container",
                json=request_data,
                headers=auth_headers,
            )

            assert response.status_code == 503


# =============================================================================
# Network Scanning Tests
# =============================================================================


class TestNetworkScanning:
    """Tests for network scanning endpoints."""

    def test_scan_network(self, auth_headers, mock_nmap_scanner):
        """Test network vulnerability scan."""
        with patch(
            "defensive_toolkit.api.routers.vulnerability.get_nmap_scanner"
        ) as mock_get:
            mock_get.return_value = mock_nmap_scanner

            request_data = {"target": "192.168.1.1", "quick": True}
            response = client.post(
                "/api/v1/vulnerability/scan/network",
                json=request_data,
                headers=auth_headers,
            )

            assert response.status_code == 200
            data = response.json()
            assert "scan_id" in data
            assert data["target"] == "192.168.1.1"

    def test_scan_network_with_ports(self, auth_headers, mock_nmap_scanner):
        """Test network scan with custom ports."""
        with patch(
            "defensive_toolkit.api.routers.vulnerability.get_nmap_scanner"
        ) as mock_get:
            mock_get.return_value = mock_nmap_scanner

            request_data = {"target": "192.168.1.1", "quick": False, "ports": "22,80,443"}
            response = client.post(
                "/api/v1/vulnerability/scan/network",
                json=request_data,
                headers=auth_headers,
            )

            assert response.status_code == 200
            mock_nmap_scanner.scan_vulnerabilities.assert_called_once_with(
                target="192.168.1.1", quick=False, ports="22,80,443"
            )


# =============================================================================
# SBOM Tests
# =============================================================================


class TestSBOMEndpoints:
    """Tests for SBOM generation and analysis endpoints."""

    def test_generate_sbom(self, auth_headers, mock_sbom_generator):
        """Test generating SBOM."""
        with patch(
            "defensive_toolkit.api.routers.vulnerability.get_sbom_generator"
        ) as mock_get:
            mock_get.return_value = mock_sbom_generator

            request_data = {
                "target": "/path/to/project",
                "target_type": "dir",
                "format": "cyclonedx-json",
            }
            response = client.post(
                "/api/v1/vulnerability/sbom/generate",
                json=request_data,
                headers=auth_headers,
            )

            assert response.status_code == 200
            data = response.json()
            assert "sbom_id" in data
            assert data["target"] == "/path/to/project"
            assert "sbom" in data

    def test_analyze_sbom(self, auth_headers, mock_sbom_generator, tmp_path):
        """Test analyzing SBOM file."""
        sbom_file = tmp_path / "sbom.json"
        sbom_file.write_text('{"bomFormat": "CycloneDX"}')

        with patch(
            "defensive_toolkit.api.routers.vulnerability.get_sbom_generator"
        ) as mock_get:
            mock_get.return_value = mock_sbom_generator
            with patch("pathlib.Path.exists", return_value=True):
                request_data = {"sbom_file": str(sbom_file)}
                response = client.post(
                    "/api/v1/vulnerability/sbom/analyze",
                    json=request_data,
                    headers=auth_headers,
                )

                assert response.status_code == 200
                data = response.json()
                assert "analysis" in data

    def test_analyze_sbom_not_found(self, auth_headers):
        """Test analyzing non-existent SBOM file."""
        with patch("pathlib.Path.exists", return_value=False):
            request_data = {"sbom_file": "nonexistent.json"}
            response = client.post(
                "/api/v1/vulnerability/sbom/analyze",
                json=request_data,
                headers=auth_headers,
            )

            assert response.status_code == 404

    def test_validate_cisa_compliance(self, auth_headers, mock_sbom_generator):
        """Test CISA compliance validation."""
        with patch(
            "defensive_toolkit.api.routers.vulnerability.get_sbom_generator"
        ) as mock_get:
            mock_get.return_value = mock_sbom_generator
            with patch("pathlib.Path.exists", return_value=True):
                request_data = {"sbom_file": "sbom.json"}
                response = client.post(
                    "/api/v1/vulnerability/sbom/validate-cisa",
                    json=request_data,
                    headers=auth_headers,
                )

                assert response.status_code == 200
                data = response.json()
                assert "validation" in data


# =============================================================================
# Risk Scoring Tests
# =============================================================================


class TestRiskScoring:
    """Tests for vulnerability risk scoring endpoints."""

    def test_score_vulnerabilities(self, auth_headers, mock_risk_scorer):
        """Test scoring vulnerabilities."""
        with patch(
            "defensive_toolkit.api.routers.vulnerability.get_risk_scorer"
        ) as mock_get:
            mock_get.return_value = mock_risk_scorer

            request_data = {
                "vulnerabilities": [
                    {"cve_id": "CVE-2021-44228", "cvss": 10.0},
                    {"cve_id": "CVE-2020-1234", "cvss": 7.5},
                ],
                "asset_criticality": "high",
                "environment": "production",
            }
            response = client.post(
                "/api/v1/vulnerability/score",
                json=request_data,
                headers=auth_headers,
            )

            assert response.status_code == 200
            data = response.json()
            assert data["total_vulnerabilities"] == 2
            assert "priority_summary" in data
            assert "scored_vulnerabilities" in data

    def test_score_vulnerabilities_invalid_criticality(self, auth_headers):
        """Test scoring with invalid asset criticality."""
        request_data = {
            "vulnerabilities": [{"cve_id": "CVE-2021-44228"}],
            "asset_criticality": "invalid",
            "environment": "production",
        }
        response = client.post(
            "/api/v1/vulnerability/score",
            json=request_data,
            headers=auth_headers,
        )

        assert response.status_code == 422


# =============================================================================
# Threat Intel Enrichment Tests
# =============================================================================


class TestThreatIntelEnrichment:
    """Tests for threat intelligence enrichment endpoints."""

    def test_enrich_vulnerabilities(self, auth_headers, mock_threat_enricher):
        """Test enriching vulnerabilities with threat intel."""
        with patch(
            "defensive_toolkit.api.routers.vulnerability.get_threat_enricher"
        ) as mock_get:
            mock_get.return_value = mock_threat_enricher

            request_data = {"vulnerabilities": [{"cve_id": "CVE-2021-44228"}]}
            response = client.post(
                "/api/v1/vulnerability/enrich",
                json=request_data,
                headers=auth_headers,
            )

            assert response.status_code == 200
            data = response.json()
            assert data["total_vulnerabilities"] == 1
            assert "enriched_vulnerabilities" in data

    def test_check_kev_status(self, auth_headers, mock_risk_scorer):
        """Test checking if CVE is in KEV catalog."""
        with patch(
            "defensive_toolkit.api.routers.vulnerability.get_risk_scorer"
        ) as mock_get:
            mock_get.return_value = mock_risk_scorer

            response = client.get(
                "/api/v1/vulnerability/kev/CVE-2021-44228",
                headers=auth_headers,
            )

            assert response.status_code == 200
            data = response.json()
            assert data["cve_id"] == "CVE-2021-44228"
            assert data["in_kev_catalog"] is True

    def test_check_kev_not_in_catalog(self, auth_headers, mock_risk_scorer):
        """Test checking CVE not in KEV catalog."""
        with patch(
            "defensive_toolkit.api.routers.vulnerability.get_risk_scorer"
        ) as mock_get:
            mock_risk_scorer.check_kev.return_value = False
            mock_get.return_value = mock_risk_scorer

            response = client.get(
                "/api/v1/vulnerability/kev/CVE-2020-9999",
                headers=auth_headers,
            )

            assert response.status_code == 200
            data = response.json()
            assert data["in_kev_catalog"] is False


# =============================================================================
# Statistics & Scanner Listing Tests
# =============================================================================


class TestStatsAndScanners:
    """Tests for statistics and scanner listing endpoints."""

    def test_get_vulnerability_stats(self, auth_headers):
        """Test getting vulnerability statistics."""
        response = client.get(
            "/api/v1/vulnerability/stats",
            headers=auth_headers,
        )

        assert response.status_code == 200
        data = response.json()
        assert "last_updated" in data
        assert "total_scans" in data
        assert "by_severity" in data

    def test_list_available_scanners(self, auth_headers):
        """Test listing available scanners."""
        response = client.get(
            "/api/v1/vulnerability/scanners",
            headers=auth_headers,
        )

        assert response.status_code == 200
        data = response.json()
        assert isinstance(data, list)


# =============================================================================
# Legacy Endpoints Tests
# =============================================================================


class TestLegacyEndpoints:
    """Tests for legacy vulnerability endpoints."""

    def test_legacy_scan_endpoint(self, auth_headers, mock_nmap_scanner):
        """Test legacy scan endpoint."""
        with patch(
            "defensive_toolkit.api.routers.vulnerability.get_nmap_scanner"
        ) as mock_get:
            mock_get.return_value = mock_nmap_scanner

            request_data = {"target": "192.168.1.1", "scan_type": "quick"}
            response = client.post(
                "/api/v1/vulnerability/scan",
                json=request_data,
                headers=auth_headers,
            )

            assert response.status_code == 200
            data = response.json()
            assert "scan_id" in data
            assert data["target"] == "192.168.1.1"

    def test_legacy_get_scan_result(self, auth_headers):
        """Test legacy get scan result endpoint."""
        response = client.get(
            "/api/v1/vulnerability/scans/scan-123",
            headers=auth_headers,
        )

        assert response.status_code == 200
        data = response.json()
        assert data["scan_id"] == "scan-123"


# =============================================================================
# Error Handling Tests
# =============================================================================


class TestErrorHandling:
    """Tests for error handling scenarios."""

    def test_openvas_scanner_unavailable(self, auth_headers):
        """Test handling when OpenVAS is unavailable."""
        with patch(
            "defensive_toolkit.api.routers.vulnerability.get_openvas_scanner"
        ) as mock_get:
            mock_get.side_effect = HTTPException(
                status_code=status.HTTP_503_SERVICE_UNAVAILABLE,
                detail="OpenVAS scanner module not available",
            )

            request_data = {"target": "192.168.1.1", "scan_type": "quick"}
            response = client.post(
                "/api/v1/vulnerability/scan/openvas",
                json=request_data,
                headers=auth_headers,
            )

            assert response.status_code == 503

    def test_nmap_scanner_unavailable(self, auth_headers):
        """Test handling when nmap is unavailable."""
        with patch(
            "defensive_toolkit.api.routers.vulnerability.get_nmap_scanner"
        ) as mock_get:
            mock_get.side_effect = HTTPException(
                status_code=status.HTTP_503_SERVICE_UNAVAILABLE,
                detail="nmap is not installed",
            )

            request_data = {"target": "192.168.1.1"}
            response = client.post(
                "/api/v1/vulnerability/scan/network",
                json=request_data,
                headers=auth_headers,
            )

            assert response.status_code == 503

    def test_sbom_generator_unavailable(self, auth_headers):
        """Test handling when syft is unavailable."""
        with patch(
            "defensive_toolkit.api.routers.vulnerability.get_sbom_generator"
        ) as mock_get:
            mock_get.side_effect = HTTPException(
                status_code=status.HTTP_503_SERVICE_UNAVAILABLE,
                detail="syft is not installed",
            )

            request_data = {"target": "/path", "target_type": "dir"}
            response = client.post(
                "/api/v1/vulnerability/sbom/generate",
                json=request_data,
                headers=auth_headers,
            )

            assert response.status_code == 503


# =============================================================================
# Authentication Tests
# =============================================================================


class TestAuthentication:
    """Tests for authentication requirements."""

    def test_scan_without_auth(self):
        """Test scan requires authentication."""
        response = client.post(
            "/api/v1/vulnerability/scan/network",
            json={"target": "192.168.1.1"},
        )
        assert response.status_code == 401

    def test_stats_without_auth(self):
        """Test stats requires authentication."""
        response = client.get("/api/v1/vulnerability/stats")
        assert response.status_code == 401

    def test_kev_check_without_auth(self):
        """Test KEV check requires authentication."""
        response = client.get("/api/v1/vulnerability/kev/CVE-2021-44228")
        assert response.status_code == 401


# =============================================================================
# Helper Function Import Error Tests
# =============================================================================


class TestHelperFunctionErrors:
    """Tests for helper function error paths."""

    def test_openvas_import_error(self, auth_headers):
        """Test OpenVAS scanner ImportError handling."""
        with patch.dict("sys.modules", {"defensive_toolkit.vulnerability_mgmt.scanners.openvas_scan": None}):
            with patch(
                "defensive_toolkit.api.routers.vulnerability.get_openvas_scanner"
            ) as mock_get:
                mock_get.side_effect = HTTPException(
                    status_code=status.HTTP_503_SERVICE_UNAVAILABLE,
                    detail="OpenVAS scanner module not available",
                )
                response = client.post(
                    "/api/v1/vulnerability/scan/openvas",
                    json={"target": "192.168.1.1"},
                    headers=auth_headers,
                )
                assert response.status_code == 503
                assert "not available" in response.json()["detail"]

    def test_container_scanner_import_error(self, auth_headers):
        """Test container scanner ImportError handling."""
        with patch(
            "defensive_toolkit.api.routers.vulnerability.get_container_scanner"
        ) as mock_get:
            mock_get.side_effect = HTTPException(
                status_code=status.HTTP_503_SERVICE_UNAVAILABLE,
                detail="Container scanner module not available",
            )
            response = client.post(
                "/api/v1/vulnerability/scan/container",
                json={"image": "nginx:latest"},
                headers=auth_headers,
            )
            assert response.status_code == 503

    def test_nmap_import_error(self, auth_headers):
        """Test nmap scanner ImportError handling."""
        with patch(
            "defensive_toolkit.api.routers.vulnerability.get_nmap_scanner"
        ) as mock_get:
            mock_get.side_effect = HTTPException(
                status_code=status.HTTP_503_SERVICE_UNAVAILABLE,
                detail="Nmap scanner module not available",
            )
            response = client.post(
                "/api/v1/vulnerability/scan/network",
                json={"target": "192.168.1.1"},
                headers=auth_headers,
            )
            assert response.status_code == 503

    def test_sbom_generator_import_error(self, auth_headers):
        """Test SBOM generator ImportError handling."""
        with patch(
            "defensive_toolkit.api.routers.vulnerability.get_sbom_generator"
        ) as mock_get:
            mock_get.side_effect = HTTPException(
                status_code=status.HTTP_503_SERVICE_UNAVAILABLE,
                detail="SBOM generator module not available",
            )
            response = client.post(
                "/api/v1/vulnerability/sbom/generate",
                json={"target": "/path", "target_type": "dir"},
                headers=auth_headers,
            )
            assert response.status_code == 503

    def test_risk_scorer_import_error(self, auth_headers):
        """Test risk scorer ImportError handling."""
        with patch(
            "defensive_toolkit.api.routers.vulnerability.get_risk_scorer"
        ) as mock_get:
            mock_get.side_effect = HTTPException(
                status_code=status.HTTP_503_SERVICE_UNAVAILABLE,
                detail="Risk scorer module not available",
            )
            response = client.post(
                "/api/v1/vulnerability/score",
                json={
                    "vulnerabilities": [{"cve_id": "CVE-2021-44228"}],
                    "asset_criticality": "high",
                    "environment": "production",
                },
                headers=auth_headers,
            )
            assert response.status_code == 503

    def test_threat_enricher_import_error(self, auth_headers):
        """Test threat enricher ImportError handling."""
        with patch(
            "defensive_toolkit.api.routers.vulnerability.get_threat_enricher"
        ) as mock_get:
            mock_get.side_effect = HTTPException(
                status_code=status.HTTP_503_SERVICE_UNAVAILABLE,
                detail="Threat intel enricher module not available",
            )
            response = client.post(
                "/api/v1/vulnerability/enrich",
                json={"vulnerabilities": [{"cve_id": "CVE-2021-44228"}]},
                headers=auth_headers,
            )
            assert response.status_code == 503


# =============================================================================
# Exception Path Tests
# =============================================================================


class TestExceptionPaths:
    """Tests for generic exception handling paths."""

    def test_openvas_scan_generic_exception(self, auth_headers, mock_openvas_scanner):
        """Test OpenVAS scan handles generic exceptions."""
        with patch(
            "defensive_toolkit.api.routers.vulnerability.get_openvas_scanner"
        ) as mock_get:
            mock_openvas_scanner.connect.return_value = True
            mock_openvas_scanner.get_scan_configs.side_effect = Exception("Unexpected error")
            mock_get.return_value = mock_openvas_scanner

            response = client.post(
                "/api/v1/vulnerability/scan/openvas",
                json={"target": "192.168.1.1"},
                headers=auth_headers,
            )
            assert response.status_code == 500
            assert "Failed to start OpenVAS scan" in response.json()["detail"]

    def test_container_scan_generic_exception(self, auth_headers, mock_container_scanner):
        """Test container scan handles generic exceptions."""
        with patch(
            "defensive_toolkit.api.routers.vulnerability.get_container_scanner"
        ) as mock_get:
            mock_container_scanner.scan_image.side_effect = Exception("Docker error")
            mock_get.return_value = mock_container_scanner

            response = client.post(
                "/api/v1/vulnerability/scan/container",
                json={"image": "nginx:latest"},
                headers=auth_headers,
            )
            assert response.status_code == 500
            assert "Container scan failed" in response.json()["detail"]

    def test_network_scan_generic_exception(self, auth_headers, mock_nmap_scanner):
        """Test network scan handles generic exceptions."""
        with patch(
            "defensive_toolkit.api.routers.vulnerability.get_nmap_scanner"
        ) as mock_get:
            mock_nmap_scanner.scan_vulnerabilities.side_effect = Exception("Network error")
            mock_get.return_value = mock_nmap_scanner

            response = client.post(
                "/api/v1/vulnerability/scan/network",
                json={"target": "192.168.1.1"},
                headers=auth_headers,
            )
            assert response.status_code == 500
            assert "Network scan failed" in response.json()["detail"]

    def test_sbom_generate_generic_exception(self, auth_headers, mock_sbom_generator):
        """Test SBOM generation handles generic exceptions."""
        with patch(
            "defensive_toolkit.api.routers.vulnerability.get_sbom_generator"
        ) as mock_get:
            mock_sbom_generator.generate_sbom.side_effect = Exception("File system error")
            mock_get.return_value = mock_sbom_generator

            response = client.post(
                "/api/v1/vulnerability/sbom/generate",
                json={"target": "/path", "target_type": "dir"},
                headers=auth_headers,
            )
            assert response.status_code == 500
            assert "SBOM generation failed" in response.json()["detail"]

    def test_sbom_analyze_generic_exception(self, auth_headers, mock_sbom_generator):
        """Test SBOM analysis handles generic exceptions."""
        with patch(
            "defensive_toolkit.api.routers.vulnerability.get_sbom_generator"
        ) as mock_get:
            mock_sbom_generator.analyze_sbom.side_effect = Exception("Parse error")
            mock_get.return_value = mock_sbom_generator
            with patch("pathlib.Path.exists", return_value=True):
                response = client.post(
                    "/api/v1/vulnerability/sbom/analyze",
                    json={"sbom_file": "sbom.json"},
                    headers=auth_headers,
                )
                assert response.status_code == 500
                assert "SBOM analysis failed" in response.json()["detail"]

    def test_scan_status_generic_exception(self, auth_headers, mock_openvas_scanner):
        """Test scan status handles generic exceptions."""
        with patch(
            "defensive_toolkit.api.routers.vulnerability.get_openvas_scanner"
        ) as mock_get:
            mock_openvas_scanner.connect.return_value = True
            mock_openvas_scanner.get_task_status.side_effect = Exception("Status fetch error")
            mock_get.return_value = mock_openvas_scanner

            response = client.get(
                "/api/v1/vulnerability/scan/task-123/status",
                headers=auth_headers,
            )
            assert response.status_code == 500
            assert "Failed to get scan status" in response.json()["detail"]

    def test_scan_results_generic_exception(self, auth_headers, mock_openvas_scanner):
        """Test scan results handles generic exceptions."""
        with patch(
            "defensive_toolkit.api.routers.vulnerability.get_openvas_scanner"
        ) as mock_get:
            mock_openvas_scanner.connect.return_value = True
            mock_openvas_scanner.get_results.side_effect = Exception("Results fetch error")
            mock_get.return_value = mock_openvas_scanner

            response = client.get(
                "/api/v1/vulnerability/scan/task-123/results",
                headers=auth_headers,
            )
            assert response.status_code == 500


# =============================================================================
# Connection Failure Tests
# =============================================================================


class TestConnectionFailures:
    """Tests for scanner connection failure scenarios."""

    def test_scan_status_connection_failure(self, auth_headers, mock_openvas_scanner):
        """Test scan status when OpenVAS connection fails."""
        with patch(
            "defensive_toolkit.api.routers.vulnerability.get_openvas_scanner"
        ) as mock_get:
            mock_openvas_scanner.connect.return_value = False
            mock_get.return_value = mock_openvas_scanner

            response = client.get(
                "/api/v1/vulnerability/scan/task-123/status",
                headers=auth_headers,
            )
            assert response.status_code == 503
            assert "connect" in response.json()["detail"].lower()

    def test_scan_results_connection_failure(self, auth_headers, mock_openvas_scanner):
        """Test scan results when OpenVAS connection fails."""
        with patch(
            "defensive_toolkit.api.routers.vulnerability.get_openvas_scanner"
        ) as mock_get:
            mock_openvas_scanner.connect.return_value = False
            mock_get.return_value = mock_openvas_scanner

            response = client.get(
                "/api/v1/vulnerability/scan/task-123/results",
                headers=auth_headers,
            )
            assert response.status_code == 503


# =============================================================================
# CISA Validation Tests
# =============================================================================


class TestCISAValidation:
    """Additional tests for CISA SBOM validation."""

    def test_cisa_validation_not_compliant(self, auth_headers, mock_sbom_generator):
        """Test CISA validation when SBOM is not compliant."""
        with patch(
            "defensive_toolkit.api.routers.vulnerability.get_sbom_generator"
        ) as mock_get:
            mock_sbom_generator.validate_cisa_compliance.return_value = {
                "compliant": False,
                "checks": {"supplier_name": "fail", "component_version": "pass"},
                "missing_fields": ["supplier_name"],
            }
            mock_get.return_value = mock_sbom_generator
            with patch("pathlib.Path.exists", return_value=True):
                response = client.post(
                    "/api/v1/vulnerability/sbom/validate-cisa",
                    json={"sbom_file": "sbom.json"},
                    headers=auth_headers,
                )
                assert response.status_code == 200
                data = response.json()
                assert data["validation"]["compliant"] is False

    def test_cisa_validation_file_not_found(self, auth_headers):
        """Test CISA validation when SBOM file not found."""
        with patch("pathlib.Path.exists", return_value=False):
            response = client.post(
                "/api/v1/vulnerability/sbom/validate-cisa",
                json={"sbom_file": "nonexistent.json"},
                headers=auth_headers,
            )
            assert response.status_code == 404

    def test_cisa_validation_generic_exception(self, auth_headers, mock_sbom_generator):
        """Test CISA validation handles generic exceptions."""
        with patch(
            "defensive_toolkit.api.routers.vulnerability.get_sbom_generator"
        ) as mock_get:
            mock_sbom_generator.validate_cisa_compliance.side_effect = Exception(
                "Validation engine error"
            )
            mock_get.return_value = mock_sbom_generator
            with patch("pathlib.Path.exists", return_value=True):
                response = client.post(
                    "/api/v1/vulnerability/sbom/validate-cisa",
                    json={"sbom_file": "sbom.json"},
                    headers=auth_headers,
                )
                assert response.status_code == 500
                assert "CISA validation failed" in response.json()["detail"]


# =============================================================================
# Severity Categorization Tests
# =============================================================================


class TestSeverityCategorization:
    """Tests for vulnerability severity categorization in scan results."""

    def test_scan_results_all_severity_levels(self, auth_headers, mock_openvas_scanner):
        """Test scan results correctly categorize all severity levels."""
        with patch(
            "defensive_toolkit.api.routers.vulnerability.get_openvas_scanner"
        ) as mock_get:
            mock_openvas_scanner.connect.return_value = True
            # Return results with all severity levels
            mock_openvas_scanner.get_results.return_value = [
                {"cve_id": "CVE-2021-44228", "name": "Critical Vuln", "severity": 10.0},
                {"cve_id": "CVE-2021-44229", "name": "High Vuln 1", "severity": 8.5},
                {"cve_id": "CVE-2021-44230", "name": "High Vuln 2", "severity": 7.0},
                {"cve_id": "CVE-2021-44231", "name": "Medium Vuln 1", "severity": 6.5},
                {"cve_id": "CVE-2021-44232", "name": "Medium Vuln 2", "severity": 4.0},
                {"cve_id": "CVE-2021-44233", "name": "Low Vuln 1", "severity": 3.9},
                {"cve_id": "CVE-2021-44234", "name": "Low Vuln 2", "severity": 1.0},
                {"cve_id": "CVE-2021-44235", "name": "Low Vuln 3", "severity": 0},
            ]
            mock_get.return_value = mock_openvas_scanner

            response = client.get(
                "/api/v1/vulnerability/scan/task-123/results",
                headers=auth_headers,
            )
            assert response.status_code == 200
            data = response.json()
            summary = data["summary"]
            assert summary["critical"] == 1  # 10.0
            assert summary["high"] == 2  # 8.5, 7.0
            assert summary["medium"] == 2  # 6.5, 4.0
            assert summary["low"] == 3  # 3.9, 1.0, 0

    def test_scan_results_only_high_severity(self, auth_headers, mock_openvas_scanner):
        """Test scan results with only high severity vulnerabilities."""
        with patch(
            "defensive_toolkit.api.routers.vulnerability.get_openvas_scanner"
        ) as mock_get:
            mock_openvas_scanner.connect.return_value = True
            mock_openvas_scanner.get_results.return_value = [
                {"cve_id": "CVE-2021-1111", "name": "High Vuln", "severity": 7.5},
            ]
            mock_get.return_value = mock_openvas_scanner

            response = client.get(
                "/api/v1/vulnerability/scan/task-123/results",
                headers=auth_headers,
            )
            assert response.status_code == 200
            data = response.json()
            assert data["summary"]["high"] == 1
            assert data["summary"]["critical"] == 0

    def test_scan_results_only_medium_severity(self, auth_headers, mock_openvas_scanner):
        """Test scan results with only medium severity vulnerabilities."""
        with patch(
            "defensive_toolkit.api.routers.vulnerability.get_openvas_scanner"
        ) as mock_get:
            mock_openvas_scanner.connect.return_value = True
            mock_openvas_scanner.get_results.return_value = [
                {"cve_id": "CVE-2021-2222", "name": "Medium Vuln", "severity": 5.5},
            ]
            mock_get.return_value = mock_openvas_scanner

            response = client.get(
                "/api/v1/vulnerability/scan/task-123/results",
                headers=auth_headers,
            )
            assert response.status_code == 200
            data = response.json()
            assert data["summary"]["medium"] == 1
            assert data["summary"]["high"] == 0

    def test_scan_results_only_low_severity(self, auth_headers, mock_openvas_scanner):
        """Test scan results with only low severity vulnerabilities."""
        with patch(
            "defensive_toolkit.api.routers.vulnerability.get_openvas_scanner"
        ) as mock_get:
            mock_openvas_scanner.connect.return_value = True
            mock_openvas_scanner.get_results.return_value = [
                {"cve_id": "CVE-2021-3333", "name": "Low Vuln", "severity": 2.0},
            ]
            mock_get.return_value = mock_openvas_scanner

            response = client.get(
                "/api/v1/vulnerability/scan/task-123/results",
                headers=auth_headers,
            )
            assert response.status_code == 200
            data = response.json()
            assert data["summary"]["low"] == 1
            assert data["summary"]["medium"] == 0


# =============================================================================
# OpenVAS SystemExit Tests
# =============================================================================


class TestOpenVASSystemExit:
    """Tests for OpenVAS SystemExit handling (GVM_PASSWORD not set)."""

    def test_openvas_system_exit_on_scan(self, auth_headers):
        """Test OpenVAS scan handles SystemExit (GVM_PASSWORD not set)."""
        with patch(
            "defensive_toolkit.api.routers.vulnerability.get_openvas_scanner"
        ) as mock_get:
            mock_get.side_effect = HTTPException(
                status_code=status.HTTP_503_SERVICE_UNAVAILABLE,
                detail="OpenVAS configuration error: GVM_PASSWORD not set",
            )
            response = client.post(
                "/api/v1/vulnerability/scan/openvas",
                json={"target": "192.168.1.1"},
                headers=auth_headers,
            )
            assert response.status_code == 503
            assert "GVM_PASSWORD" in response.json()["detail"]

    def test_openvas_system_exit_on_status(self, auth_headers):
        """Test OpenVAS status handles SystemExit (GVM_PASSWORD not set)."""
        with patch(
            "defensive_toolkit.api.routers.vulnerability.get_openvas_scanner"
        ) as mock_get:
            mock_get.side_effect = HTTPException(
                status_code=status.HTTP_503_SERVICE_UNAVAILABLE,
                detail="OpenVAS configuration error: GVM_PASSWORD not set",
            )
            response = client.get(
                "/api/v1/vulnerability/scan/task-123/status",
                headers=auth_headers,
            )
            assert response.status_code == 503

    def test_openvas_system_exit_on_results(self, auth_headers):
        """Test OpenVAS results handles SystemExit (GVM_PASSWORD not set)."""
        with patch(
            "defensive_toolkit.api.routers.vulnerability.get_openvas_scanner"
        ) as mock_get:
            mock_get.side_effect = HTTPException(
                status_code=status.HTTP_503_SERVICE_UNAVAILABLE,
                detail="OpenVAS configuration error: GVM_PASSWORD not set",
            )
            response = client.get(
                "/api/v1/vulnerability/scan/task-123/results",
                headers=auth_headers,
            )
            assert response.status_code == 503


# =============================================================================
# Additional Exception Path Tests
# =============================================================================


class TestAdditionalExceptionPaths:
    """Tests for additional exception handling paths."""

    def test_risk_scoring_generic_exception(self, auth_headers):
        """Test risk scoring handles generic exceptions."""
        with patch(
            "defensive_toolkit.api.routers.vulnerability.get_risk_scorer"
        ) as mock_get:
            mock_scorer = MagicMock()
            mock_scorer.score_vulnerabilities.side_effect = Exception("Scoring engine error")
            mock_get.return_value = mock_scorer

            response = client.post(
                "/api/v1/vulnerability/score",
                json={
                    "vulnerabilities": [{"cve_id": "CVE-2021-44228"}],
                    "asset_criticality": "high",
                    "environment": "production",
                },
                headers=auth_headers,
            )
            assert response.status_code == 500
            assert "Risk scoring failed" in response.json()["detail"]

    def test_enrichment_generic_exception(self, auth_headers):
        """Test enrichment handles generic exceptions."""
        with patch(
            "defensive_toolkit.api.routers.vulnerability.get_threat_enricher"
        ) as mock_get:
            mock_enricher = MagicMock()
            mock_enricher.load_kev.return_value = None
            mock_enricher.enrich_vulnerabilities.side_effect = Exception("Enrichment error")
            mock_get.return_value = mock_enricher

            response = client.post(
                "/api/v1/vulnerability/enrich",
                json={"vulnerabilities": [{"cve_id": "CVE-2021-44228"}]},
                headers=auth_headers,
            )
            assert response.status_code == 500
            assert "enrichment failed" in response.json()["detail"].lower()

    def test_kev_check_generic_exception(self, auth_headers):
        """Test KEV check handles generic exceptions."""
        with patch(
            "defensive_toolkit.api.routers.vulnerability.get_risk_scorer"
        ) as mock_get:
            mock_scorer = MagicMock()
            mock_scorer.load_kev_catalog.side_effect = Exception("KEV catalog error")
            mock_get.return_value = mock_scorer

            response = client.get(
                "/api/v1/vulnerability/kev/CVE-2021-44228",
                headers=auth_headers,
            )
            assert response.status_code == 500
            assert "KEV check failed" in response.json()["detail"]

    def test_legacy_scan_generic_exception(self, auth_headers, mock_nmap_scanner):
        """Test legacy scan falls back on generic exceptions."""
        with patch(
            "defensive_toolkit.api.routers.vulnerability.get_nmap_scanner"
        ) as mock_get:
            mock_nmap_scanner.scan_vulnerabilities.side_effect = Exception("Scan failed")
            mock_get.return_value = mock_nmap_scanner

            response = client.post(
                "/api/v1/vulnerability/scan",
                json={"target": "192.168.1.1", "scan_type": "quick"},
                headers=auth_headers,
            )
            # Legacy endpoint falls back to mock response
            assert response.status_code == 200
            data = response.json()
            assert "scan_id" in data
