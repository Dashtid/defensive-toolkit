# Malware Infection Response Runbook
# Defensive Toolkit v1.0.0
#
# Response playbook for general malware infections (trojans, RATs, infostealers).
# Excludes ransomware - use ransomware.yaml for ransomware incidents.

name: Malware Infection Response
description: Automated response playbook for malware infections
version: "1.0.0"
author: Defensive Toolkit
created: 2025-11-30
updated: 2025-11-30

metadata:
  mitre_attack:
    - T1059  # Command and Scripting Interpreter
    - T1055  # Process Injection
    - T1547  # Boot or Logon Autostart Execution
    - T1041  # Exfiltration Over C2 Channel
  severity: high
  estimated_duration: 30-60 minutes

variables:
  alert_email: "security@company.com"
  quarantine_dir: "/tmp/ir-quarantine"

steps:
  # Phase 1: Initial Response
  - name: Log incident start
    action: log
    severity: low
    parameters:
      message: "Malware infection response initiated on ${hostname}"
      level: info

  - name: Send initial notification
    action: send_alert
    severity: medium
    parameters:
      method: email
      recipients:
        - "${alert_email}"
      subject: "HIGH: Malware Detected - ${hostname}"
      message: |
        Malware infection detected on ${hostname}.

        Incident ID: ${incident_id}
        Detection Time: ${timestamp}
        Analyst: ${analyst}

        Automated response in progress.
      severity: high

  # Phase 2: Evidence Collection (before containment)
  - name: Capture running processes
    action: collect_evidence
    severity: medium
    description: Capture process list before any termination
    parameters:
      evidence_type: processes
      source: "*"
      output_dir: "./ir-output/${incident_id}/evidence"

  - name: Capture network connections
    action: collect_evidence
    severity: medium
    description: Document active network connections
    parameters:
      evidence_type: network
      source: "*"
      output_dir: "./ir-output/${incident_id}/evidence"

  - name: Run system triage
    action: run_triage
    severity: medium
    parameters:
      target: localhost
      type: auto

  # Phase 3: Containment
  - name: Block malicious IP
    action: prompt_analyst
    severity: medium
    parameters:
      prompt: "Enter C2/malicious IP to block (or 'skip')"
      variable: malicious_ip

  - name: Execute IP block
    action: block_ip
    severity: high
    description: Block communication to malicious infrastructure
    when: "malicious_ip != 'skip'"
    parameters:
      ip_address: "${malicious_ip}"
      direction: both

  # Phase 4: Eradication
  - name: Identify malicious process
    action: prompt_analyst
    severity: medium
    parameters:
      prompt: "Enter malicious process name or PID to terminate (or 'skip')"
      variable: malware_process

  - name: Terminate malware process
    action: kill_process
    severity: high
    when: "malware_process != 'skip'"
    parameters:
      process_name: "${malware_process}"
      force: true

  - name: Identify malware file
    action: prompt_analyst
    severity: medium
    parameters:
      prompt: "Enter path to malware file to quarantine (or 'skip')"
      variable: malware_file

  - name: Quarantine malware
    action: quarantine_file
    severity: high
    when: "malware_file != 'skip'"
    parameters:
      file_path: "${malware_file}"
      quarantine_dir: "${quarantine_dir}"
      preserve_metadata: true

  # Phase 5: Persistence Check
  - name: Collect registry persistence
    action: collect_evidence
    severity: medium
    description: Check for registry-based persistence
    parameters:
      evidence_type: registry
      source: forensic
      output_dir: "./ir-output/${incident_id}/evidence"

  - name: Collect scheduled tasks
    action: collect_evidence
    severity: medium
    description: Check for scheduled task persistence
    parameters:
      evidence_type: scheduled_tasks
      source: "*"
      output_dir: "./ir-output/${incident_id}/evidence"

  - name: Collect services
    action: collect_evidence
    severity: low
    description: Document installed services
    parameters:
      evidence_type: services
      source: "*"
      output_dir: "./ir-output/${incident_id}/evidence"

  # Phase 6: Package & Report
  - name: Collect event logs
    action: collect_evidence
    severity: low
    parameters:
      evidence_type: logs
      source: system
      output_dir: "./ir-output/${incident_id}/evidence"

  - name: Create forensic package
    action: create_forensic_package
    severity: low
    parameters:
      evidence_dir: "./ir-output/${incident_id}/evidence"
      output_file: "./ir-output/${incident_id}/${incident_id}_malware_package.zip"

  - name: Send completion report
    action: send_alert
    severity: low
    parameters:
      method: email
      recipients:
        - "${alert_email}"
      subject: "Malware Response Complete - ${incident_id}"
      message: |
        Malware infection response completed.

        Incident ID: ${incident_id}
        Host: ${hostname}

        Actions Taken:
        - Evidence collected (processes, network, persistence)
        - Malicious communications blocked (if identified)
        - Malware process terminated (if identified)
        - Malware file quarantined (if identified)
        - Forensic package created

        Recommended Follow-up:
        1. Submit malware sample to sandbox analysis
        2. Check for lateral movement indicators
        3. Scan other endpoints for same IOCs
        4. Update detection rules
        5. Reset compromised credentials (if applicable)
      severity: medium

  - name: Log completion
    action: log
    severity: low
    parameters:
      message: "Malware infection response completed for ${incident_id}"
      level: info
