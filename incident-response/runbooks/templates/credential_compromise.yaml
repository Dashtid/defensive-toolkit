# Credential Compromise Response Runbook
# Defensive Toolkit v1.0.0
#
# Response playbook for compromised credentials, including:
# - Credential theft/dumping
# - Phishing-obtained credentials
# - Password spray attacks
# - Kerberoasting/DCSync

name: Credential Compromise Response
description: Automated response playbook for credential compromise incidents
version: "1.0.0"
author: Defensive Toolkit
created: 2025-11-30
updated: 2025-11-30

metadata:
  mitre_attack:
    - T1003  # OS Credential Dumping
    - T1558  # Steal or Forge Kerberos Tickets
    - T1110  # Brute Force
    - T1078  # Valid Accounts
  severity: high
  estimated_duration: 30-45 minutes

variables:
  alert_email: "security@company.com"
  compromised_user: ""  # Set via prompt or --variables

steps:
  # Phase 1: Initial Assessment
  - name: Log incident initiation
    action: log
    severity: low
    parameters:
      message: "Credential compromise response initiated"
      level: info

  - name: Get compromised username
    action: prompt_analyst
    severity: low
    description: Identify the compromised account
    parameters:
      prompt: "Enter the compromised username (e.g., jsmith or DOMAIN\\jsmith)"
      variable: compromised_user

  - name: Send initial alert
    action: send_alert
    severity: high
    parameters:
      method: email
      recipients:
        - "${alert_email}"
      subject: "HIGH: Credential Compromise - ${compromised_user}"
      message: |
        Credential compromise detected.

        Incident ID: ${incident_id}
        Compromised Account: ${compromised_user}
        Detection Time: ${timestamp}
        Source Host: ${hostname}

        Immediate action required to prevent unauthorized access.
      severity: high

  # Phase 2: Containment
  - name: Disable compromised account
    action: disable_account
    severity: critical
    description: Immediately disable the compromised account
    parameters:
      username: "${compromised_user}"
      method: disable

  - name: Log account disabled
    action: log
    severity: low
    parameters:
      message: "Account ${compromised_user} has been disabled"
      level: info

  # Phase 3: Evidence Collection
  - name: Collect user session info
    action: collect_evidence
    severity: medium
    description: Document current user sessions
    parameters:
      evidence_type: users
      source: "*"
      output_dir: "./ir-output/${incident_id}/evidence"

  - name: Collect authentication logs
    action: collect_evidence
    severity: medium
    description: Preserve authentication event logs
    parameters:
      evidence_type: logs
      source: system
      output_dir: "./ir-output/${incident_id}/evidence"

  - name: Collect network connections
    action: collect_evidence
    severity: medium
    description: Document active sessions from compromised account
    parameters:
      evidence_type: network
      source: "*"
      output_dir: "./ir-output/${incident_id}/evidence"

  - name: Run triage collection
    action: run_triage
    severity: medium
    parameters:
      target: localhost
      type: auto

  # Phase 4: Scope Assessment
  - name: Prompt for additional accounts
    action: prompt_analyst
    severity: medium
    parameters:
      prompt: "Enter additional related accounts to disable (comma-separated, or 'none')"
      variable: related_accounts

  - name: Block attacker IP
    action: prompt_analyst
    severity: medium
    parameters:
      prompt: "Enter attacker source IP to block (or 'skip')"
      variable: attacker_ip

  - name: Execute IP block
    action: block_ip
    severity: high
    when: "attacker_ip != 'skip'"
    parameters:
      ip_address: "${attacker_ip}"
      direction: inbound

  # Phase 5: Create Ticket
  - name: Create incident ticket
    action: create_ticket
    severity: medium
    parameters:
      system: jira
      title: "Credential Compromise - ${compromised_user}"
      description: |
        Credential compromise incident.

        Incident ID: ${incident_id}
        Compromised User: ${compromised_user}
        Source Host: ${hostname}
        Detection Time: ${timestamp}

        Actions Taken:
        - Account disabled
        - Evidence collected
        - Attacker IP blocked (if identified)

        Required Follow-up:
        - Force password reset when re-enabling
        - Review account activity in last 30 days
        - Check for lateral movement
        - Review MFA status
      priority: high

  # Phase 6: Package Evidence
  - name: Create forensic package
    action: create_forensic_package
    severity: low
    parameters:
      evidence_dir: "./ir-output/${incident_id}/evidence"
      output_file: "./ir-output/${incident_id}/${incident_id}_credential_package.zip"

  # Phase 7: Notification
  - name: Send completion notification
    action: send_alert
    severity: low
    parameters:
      method: email
      recipients:
        - "${alert_email}"
      subject: "Credential Compromise Response Complete - ${incident_id}"
      message: |
        Credential compromise response completed.

        Incident ID: ${incident_id}
        Compromised Account: ${compromised_user}

        Actions Taken:
        - Account ${compromised_user} disabled
        - Authentication logs collected
        - Network connections documented
        - Attacker IP blocked (if identified)
        - Forensic package created

        REQUIRED FOLLOW-UP:
        1. Investigate account activity for unauthorized access
        2. Check for data exfiltration
        3. Review other systems accessed by this account
        4. Force password reset before re-enabling
        5. Enable/verify MFA on account
        6. Notify user of compromise
        7. Check if credentials were reused elsewhere
      severity: medium

  - name: Log completion
    action: log
    severity: low
    parameters:
      message: "Credential compromise response completed for ${compromised_user}"
      level: info
