# Malware Infection Response Playbook

**Severity**: HIGH
**MITRE ATT&CK**: T1204 - User Execution, T1566 - Phishing
**Last Updated**: 2025-10-15

## Overview

This playbook provides procedures for responding to malware infections on endpoints, from detection through remediation.

## Quick Reference

**Immediate Actions (First 5 Minutes):**
1. Isolate infected system from network
2. Alert security team
3. Preserve system state (do not reboot yet)
4. Document visible indicators

## Phase 1: Detection and Verification (0-30 minutes)

### Detection Indicators

**Behavioral Indicators:**
- [ ] Unusual CPU or memory usage
- [ ] Unexpected network connections
- [ ] New unknown processes running
- [ ] Disabled security tools
- [ ] Unexpected system changes
- [ ] Pop-ups or system messages
- [ ] Slow system performance

**Technical Indicators:**
- [ ] AV/EDR alerts triggered
- [ ] SIEM correlation rules fired
- [ ] Suspicious file creations
- [ ] Registry modifications
- [ ] Scheduled task additions
- [ ] Service installations

### Initial Verification

1. **Confirm Malware Presence**
   ```powershell
   # Check running processes
   Get-Process | Sort-Object CPU -Descending | Select-Object -First 20

   # Check network connections
   Get-NetTCPConnection | Where-Object {$_.State -eq "Established"}

   # Check recent file modifications
   Get-ChildItem -Path C:\ -Recurse -File |
       Where-Object {$_.LastWriteTime -gt (Get-Date).AddHours(-2)}
   ```

2. **Gather Initial Evidence**
   ```powershell
   # Take screenshot
   Add-Type -AssemblyName System.Windows.Forms
   [System.Windows.Forms.SendKeys]::SendWait("{PRTSC}")

   # Export process list
   Get-Process | Export-Csv -Path C:\IR\processes.csv

   # Export network connections
   Get-NetTCPConnection | Export-Csv -Path C:\IR\network_connections.csv
   ```

## Phase 2: Containment (30 minutes - 1 hour)

### Network Isolation

1. **Isolate System**
   ```powershell
   # Disable all network adapters
   Get-NetAdapter | Disable-NetAdapter -Confirm:$false

   # Alternative: Block at firewall
   # Document isolation time and method
   ```

2. **Prevent Lateral Movement**
   ```powershell
   # Check for shared folders
   Get-SmbShare

   # Check for RDP sessions
   query user

   # Check for mapped drives
   net use
   ```

### Preserve Evidence

3. **Create Memory Dump**
   ```powershell
   # Using built-in tools
   # Path to output directory
   $outputDir = "C:\IR\Evidence\"

   # Capture full memory dump (requires Sysinternals ProcDump or DumpIt)
   .\DumpIt.exe /O $outputDir\memory.raw

   # Hunt for malware in memory
   python forensics\memory\hunt-malware.py $outputDir\memory.raw --output $outputDir\memory_analysis
   ```

4. **Collect Volatile Data**
   ```powershell
   # Run triage script
   .\incident-response\scripts\windows-triage.ps1 -Quick -OutputDir C:\IR\Evidence

   # Hunt for persistence mechanisms
   .\forensics\artifacts\persistence\hunt-persistence.ps1 -OutputDir C:\IR\Evidence\persistence

   # Extract registry artifacts
   .\forensics\artifacts\registry\extract-registry-artifacts.ps1 -OutputDir C:\IR\Evidence\registry
   ```

## Phase 3: Investigation (1-4 hours)

### Malware Analysis

1. **Identify Malware Sample**
   ```powershell
   # Locate suspicious files
   Get-ChildItem -Path C:\Users\*\Downloads,C:\Users\*\AppData\Local\Temp -File |
       Where-Object {$_.CreationTime -gt (Get-Date).AddHours(-24)}

   # Calculate file hashes
   Get-FileHash -Path C:\path\to\suspicious\file.exe -Algorithm SHA256
   ```

2. **Check VirusTotal**
   ```bash
   # Upload hash to VirusTotal (not the file itself)
   # Check community comments for IOCs
   # Note detection names from various AVs
   ```

3. **Analyze with YARA**
   ```bash
   # Scan with YARA rules
   yara -r detection-rules/yara/*.yar C:\path\to\suspicious\file.exe
   ```

### Determine Infection Vector

4. **Email Analysis** (if phishing suspected)
   ```powershell
   # Check email logs
   # Review sender, attachments, links
   # Identify other potential victims
   ```

5. **Web Activity** (if drive-by download)
   ```powershell
   # Extract browser history automatically
   python forensics\artifacts\browser\extract-browser-history.py --user-profile C:\Users\target_user --output C:\IR\Evidence\browser

   # Review proxy logs for suspicious URLs
   ```

6. **Removable Media**
   ```powershell
   # Check for USB device history
   Get-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Enum\USBSTOR\*"
   ```

### Scope Assessment

7. **Check for Persistence**
   ```powershell
   # Registry run keys
   Get-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run"
   Get-ItemProperty -Path "HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run"

   # Scheduled tasks
   Get-ScheduledTask | Where-Object {$_.TaskPath -notlike "\Microsoft\*"}

   # Services
   Get-Service | Where-Object {$_.DisplayName -notlike "*Microsoft*" -and $_.Status -eq "Running"}

   # Startup folder
   Get-ChildItem "$env:APPDATA\Microsoft\Windows\Start Menu\Programs\Startup"
   ```

8. **Identify C2 Communication**
   ```powershell
   # Active connections
   Get-NetTCPConnection -State Established |
       Where-Object {$_.RemoteAddress -notlike "10.*" -and
                     $_.RemoteAddress -notlike "192.168.*" -and
                     $_.RemoteAddress -notlike "172.*"}

   # DNS queries (requires DNS logging)
   # Check firewall logs for suspicious outbound connections
   ```

## Phase 4: Eradication (4-8 hours)

### Malware Removal Options

**Option 1: Clean In-Place** (Low to Medium Infection)
```powershell
# 1. Terminate malicious processes
Stop-Process -Id [PID] -Force

# 2. Delete malicious files
Remove-Item -Path "C:\path\to\malware.exe" -Force

# 3. Remove persistence mechanisms
Unregister-ScheduledTask -TaskName "MaliciousTask"
Remove-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" -Name "BadEntry"

# 4. Kill services
Stop-Service -Name "MaliciousService"
sc.exe delete "MaliciousService"

# 5. Clean registry
Remove-Item -Path "HKLM:\SOFTWARE\Malware\*" -Recurse
```

**Option 2: System Reimage** (Severe Infection - RECOMMENDED)
```bash
# 1. Back up user data (scan for malware first)
# 2. Rebuild system from known-good image
# 3. Apply all security patches
# 4. Reinstall applications
# 5. Restore user data
# 6. Full antivirus scan before reconnecting
```

### Credential Reset

1. **Reset Compromised Credentials**
   ```powershell
   # Local user
   Set-LocalUser -Name username -Password (ConvertTo-SecureString -AsPlainText "NewP@ssw0rd!" -Force)

   # Domain user
   Set-ADAccountPassword -Identity username -Reset -NewPassword (ConvertTo-SecureString -AsPlainText "NewP@ssw0rd!" -Force)

   # Force password change
   Set-ADUser -Identity username -ChangePasswordAtLogon $true
   ```

2. **Revoke Active Sessions**
   ```powershell
   # Log off user sessions
   query user
   logoff [session_id]
   ```

## Phase 5: Recovery (Variable)

### System Validation

1. **Full Security Scan**
   ```powershell
   # Windows Defender full scan
   Start-MpScan -ScanType FullScan

   # Additional AV tools
   # Run multiple scanners for validation
   ```

2. **Verify Removal**
   ```powershell
   # Check for persistence again
   # Review process list
   # Monitor network connections
   # Verify malware artifacts removed
   ```

### Monitoring

3. **Enhanced Monitoring (72 hours)**
   ```powershell
   # Enable enhanced logging
   wevtutil sl Security /ms:104857600
   wevtutil sl System /ms:104857600

   # Monitor for:
   - Unexpected processes
   - Unusual network activity
   - File system changes
   - Registry modifications
   ```

4. **Reconnect to Network**
   ```powershell
   # Only after complete validation
   Get-NetAdapter | Enable-NetAdapter

   # Monitor closely for 24-48 hours
   ```

## Phase 6: Post-Incident (Ongoing)

### Root Cause Analysis

1. **Document Timeline**
   - Initial infection time
   - Detection time
   - Containment time
   - Resolution time

2. **Identify Vulnerabilities**
   - How did malware enter?
   - Why did AV not detect it?
   - What controls failed?
   - What worked well?

### Security Improvements

3. **Apply Lessons Learned**
   - [ ] Update AV/EDR signatures
   - [ ] Add IOCs to blocklists
   - [ ] Patch exploited vulnerabilities
   - [ ] Update email filters
   - [ ] Improve web filtering
   - [ ] Enhance user training

4. **Share Intelligence**
   - Document IOCs (hashes, IPs, domains)
   - Share with security community
   - Update internal threat intelligence
   - Add to SIEM correlation rules

## Malware Types and Specific Actions

### Banking Trojans
- Check for keylogger activity
- Review financial account access
- Reset banking credentials immediately
- Alert fraud department

### Info Stealers
- Assume all credentials compromised
- Force password resets
- Check for data exfiltration
- Review browser saved passwords

### RATs (Remote Access Trojans)
- Assume complete system compromise
- Rebuild system (don't clean)
- Review all accessed data
- Check for lateral movement

### Downloaders/Droppers
- Search for additional payloads
- Check for second-stage malware
- Review C2 communications
- Scan network for similar infections

## Communication Plan

### User Communication
```
Your system has been isolated due to a potential malware infection.

WHAT HAPPENED:
[Brief description]

WHAT WE'RE DOING:
- Analyzing the infection
- Removing the malware
- Protecting other systems

WHAT YOU NEED TO DO:
- Do not use this system
- Change passwords on another device
- Report any suspicious emails/activities
- Contact IT for a loaner system if needed

TIMELINE:
Estimated resolution: [TIME]

CONTACT:
[IT Contact Information]
```

## Tools and Resources

### Analysis Tools
- Process Explorer (Sysinternals)
- Autoruns (Sysinternals)
- ProcDump (Sysinternals)
- YARA rules: `detection-rules/yara/`

### Forensics Tools
- Memory analysis: `forensics/memory/volatility-auto-analyze.py`, `forensics/memory/hunt-malware.py`
- Disk analysis: `forensics/disk/extract-mft.py`, `forensics/disk/carve-files.py`
- Artifact collection: `forensics/artifacts/registry/`, `forensics/artifacts/browser/`, `forensics/artifacts/persistence/`
- Timeline: `forensics/timeline/generate-timeline.py`, `forensics/timeline/analyze-timeline.py`

### Triage Scripts
- Windows: `incident-response/scripts/windows-triage.ps1`
- Linux: `incident-response/scripts/linux-triage.sh`

### Threat Intelligence
- VirusTotal: https://www.virustotal.com/
- Hybrid Analysis: https://www.hybrid-analysis.com/
- Any.Run: https://any.run/

## Checklist

### Initial Response
- [ ] Isolate infected system
- [ ] Alert security team
- [ ] Preserve system state
- [ ] Document indicators
- [ ] Collect volatile data

### Investigation
- [ ] Identify malware sample
- [ ] Calculate file hashes
- [ ] Check VirusTotal
- [ ] Scan with YARA rules
- [ ] Determine infection vector
- [ ] Check for persistence
- [ ] Identify C2 communications

### Eradication
- [ ] Terminate malicious processes
- [ ] Remove malicious files
- [ ] Clean persistence mechanisms
- [ ] Delete services
- [ ] Clean registry entries
- [ ] Reset credentials
- [ ] Revoke active sessions

### Recovery
- [ ] Full security scan
- [ ] Verify malware removal
- [ ] Enable enhanced monitoring
- [ ] Reconnect to network (after validation)
- [ ] Monitor for 72 hours

### Post-Incident
- [ ] Document timeline
- [ ] Identify root cause
- [ ] Apply security improvements
- [ ] Share IOCs
- [ ] Update documentation
- [ ] Conduct user training

---

**REMEMBER:**
- Document everything you do
- Preserve evidence at all times
- Consider reimaging for severe infections
- Don't assume malware is fully removed until validated
- Monitor closely after reconnection
